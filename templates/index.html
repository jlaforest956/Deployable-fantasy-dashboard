<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ payload.team }} – Week {{ payload.week }} | Weekly Fantasy Report</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body { font-family: Arial, sans-serif; background:#f7f9fb; color:#222; margin:0; padding:20px; }
    .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; margin-bottom:6px; }
    .topbar { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom: 20px; }
    .chip { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#555; background:#fafafa; }
    .actions { text-align:center; margin: 6px 0 18px; }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #0f62fe; color:#0f62fe; border-radius:6px; text-decoration:none; font-size:14px; background:#eef4ff; }
    .btn:hover { background:#e4eeff; }
    table { width:100%; border-collapse: collapse; margin: 12px 0 24px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:#f0f3f6; }
    .start-row { background:#eafaf1; color:#1e7e34; font-weight:600; }
    .bench-row { background:#fdecea; color:#a71d2a; font-weight:600; }
    .hint { font-size:0.9em; color:#0a58ca; display:block; margin-top:4px; }
    .delta { font-size:0.85em; color:#555; margin-left:4px; }
    ul { list-style:none; padding:0; }
    li { margin:8px 0; padding:8px; background:#f9f9f9; border:1px solid #eee; border-radius:4px; }
    .foot { text-align:center; margin-top: 24px; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ payload.team }} — Week {{ payload.week }}</h1>
    <div class="topbar">
      <span class="chip">vs {{ payload.opponent }}</span>
      <span class="chip">Proj: {{ payload.proj.me }} – {{ payload.proj.opp }}</span>
      <span class="chip">{{ payload.strategy_bias|capitalize }} strategy</span>
    </div>
    <div class="actions">
      <a class="btn" href="{{ url_for('refresh') }}">↻ Refresh</a>
      <a class="btn" href="{{ url_for('json_api') }}">View JSON</a>
      <a class="btn" href="{{ url_for('health') }}">Health</a>
    </div>

    {% if raw_text %}
      <h2>⚠️ AI Response (Raw Text)</h2>
      <pre>{{ raw_text }}</pre>
    {% else %}
      <h2>Starters (with AI Advice)</h2>
      <table>
        <thead>
          <tr>
            <th>Slot</th>
            <th>Player</th>
            <th>Pos</th>
            <th>Projection</th>
            <th>Verdict</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          {% for s in payload.my_starters %}
            {% set row = start_sit_by_slot.get(s.slot) %}
            {% if row %}
              {% set is_bench = (row.verdict[:10] == 'Bench for ') %}
              {% if is_bench %}
                {% set bench_name = row.verdict[10:] %}
                {% set s_proj = wk_by_name.get(s.name, s.wk_proj) %}
                {% set b_proj = wk_by_name.get(bench_name) %}
                <tr class="bench-row">
                  <td>{{ s.slot }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.pos }}</td>
                  <td>{{ "%.2f"|format(s_proj) }}</td>
                  <td>
                    Bench for <strong>{{ bench_name }}</strong>
                    {% if b_proj is not none %}
                      <span class="delta">(→ {{ "%.2f"|format(b_proj) }} | Δ {{ "%.2f"|format(b_proj - s_proj) }})</span>
                    {% endif %}
                  </td>
                  <td>{{ row.reason }}</td>
                </tr>
              {% else %}
                {% set hint = local_hints.get(s.name) %}
                <tr class="start-row">
                  <td>{{ s.slot }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.pos }}</td>
                  <td>{{ "%.2f"|format(s.wk_proj) }}</td>
                  <td>
                    Start
                    {% if hint and hint.delta > 0.3 %}
                      <span class="hint">Local model suggests:
                        Bench for <strong>{{ hint.start.name }}</strong>
                        <span class="delta">(+{{ "%.2f"|format(hint.delta) }})</span>
                      </span>
                    {% endif %}
                  </td>
                  <td>{{ row.reason }}</td>
                </tr>
              {% endif %}
            {% else %}
              <tr>
                <td>{{ s.slot }}</td>
                <td>{{ s.name }}</td>
                <td>{{ s.pos }}</td>
                <td>{{ "%.2f"|format(s.wk_proj) }}</td>
                <td>Start</td>
                <td></td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>

      <h2>Bench (ranked)</h2>
      <ul>
        {% for b in report.bench_ranked %}
          <li>{{ b.name }} ({{ b.pos }}) — Proj {{ "%.2f"|format(b.wk_proj) }}</li>
        {% endfor %}
      </ul>

      <h2>Top Waiver Targets</h2>
      <ul>
        {% for w in report.waivers %}
          <li>
            <strong>Add</strong> {{ w.add }} → <strong>Drop</strong> {{ w.drop }}<br>
            <small>{{ w.why }}</small>
          </li>
        {% endfor %}
      </ul>

      <h2>Trade Targets</h2>
      <ul>
        {% for t in report.trades %}
          <li><strong>{{ t.target }}</strong><br><small>{{ t.why }}</small></li>
        {% endfor %}
      </ul>

      <h2>Risk Flags</h2>
      <ul>
        {% for r in report.risks %}
          <li>{{ r }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <div class="foot">
      Deployed? Add a Render cron to GET <code>/cron</code> daily. |
      <a href="{{ url_for('json_api') }}">JSON</a> • <a href="{{ url_for('health') }}">Health</a>
    </div>
  </div>
</body>
</html>
